# Redis的持久化

Redis虽然是内存缓存，但还是提供了持久化机制，分别是RDB、AOF和RAOF。

## 数据持久化过程

1. 系统收到需要持久化的数据，此时数据在应用程序的内存中。
2. 系统调用write系统调用，将数据写入磁盘，此时数据可能并没有真正的持久化到磁盘，数据在操作系统的缓冲区中。
3. 操作系统将缓冲区中的数据输出到磁盘控制器，此时数据在磁盘的缓存上。
4. 磁盘控制器将数据写入到磁盘的物理介质上，数据真正的写入到磁盘，在任何情况下可以再次被读取。

从上面的过程可以看到有两种情况的故障：
1. 系统发生故障，只要1、2完成，那么就可以持久化，剩下的3、4操作系统会完成。
2. 操作系统故障，机器故障，只有1、2、3、4都完成，才能持久化。

## RDB持久化

RDB持久化就是将内存中的数据集以快照的形式写入到一个二进制文件中，以持久化到磁盘上，redis中默认的文件名为dump.rdb。

既然RDB持久化是在某个时刻将所有数据生成一个快照保存，那么就需要一个触发机制，以完成这个过程。Redis提供了三种机制：save、bgsave、自动化。

### save触发方式

save方式会阻塞Redis的服务，在save期间，Redis不能处理其他命令，直到save过程完成，流程如下：

![](pic/redis.save.jpeg)

save完成后，如果有老的RDB，则用新生成的RDB替换老的。

### bgsave触发方式

bgsave会fork子进程从而在后台异步完成快照操作，而前台的父进程可以继续响应客户端请求。

![](pic/redis.bgsave.jpeg)

### 自动触发